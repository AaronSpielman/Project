---
title: "Data Munging & EDA Project"
author: "Aaron Spielman"
date: "2022-12-04"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(dplyr)
library(cowplot)
```

## Contributions

### Summary and Munging

AS produced the series of boxplots, built the linear model that shows a 2050 PPB prediction for the three greenhouse gases of interest and contributed to the summary of the EDA findings.

```{r, echo=F, message=F, warning=FALSE}
library(data.table)

#-----Importing NOAA greenhouse gas data-----#

# Set dir to project dir
# NOTE: CHANGE THIS TO YOUR PROJECT DIRECTORY!
project.dir <- "C:/Users/jvons/Documents/NCF/Data_Munging_EDA/Data_Munging"
data.dir <- "Datasets"
setwd(file.path(project.dir, data.dir))

# Read files using awk to parse data for only 2003 - present
# gas.data <- lapply(1:length(gas.files), function(x) system(paste("awk '{if ($1 > 2002) print $0}'", gas.files[[x]]), intern = TRUE))
# Note that trying to read.delim() from pipe was not working, and output can only be captured as a character vector with system()
    # pipe() was interpreting $1 > 2002 as a redirect

# Instead, used awk from the terminal:
# prefix=$(ls | sed -r "s/[.]txt//"); for name in ${prefix}; do awk '{if ($1 > 2002) print $0}' "${name}.txt" > "${name}-filtered.txt"; done

# Get list of gases of interest for which we have data
gas.list <- c("ch4", "n2o", "sf6")
gas.files <- lapply(gas.list, function(x) list.files(path = ".", pattern = paste0(x, ".*filtered\\.txt")))

# Read files into df
gas.data <- lapply(gas.files, fread)
names(gas.data) <- gas.list

# CH4 is in ppm, N2O is in ppb, SF6 is in ppt - standardize entries to ppb and rename entries
gas.colnames <- c("Year",
                  "Month",
                  "Year_Day_decimal",
                  "Average_ppb",
                  "Uncertainty_avg",
                  "Trend",
                  "Uncertainty_trend")
gas.data <- lapply(gas.data, function(x) setNames(x, gas.colnames))
gas.data$ch4$Average_ppb <- gas.data$ch4$Average_ppb * 1000
gas.data$sf6$Average_ppb <- gas.data$sf6$Average_ppb / 1000

# To do time-series analysis, we probably want to convert the Year/month cols into a single date col, e.g.,
# as.Date("2002-1-1", format = "%Y-%m-%d")

#-----Importing NASA GISTEMP data-----
# Hacky way of doing it, but it works - this is based on the output of fread()
# Namely, fread() stopped at line 24 because of the presence of a string character
# Reverse-engineer the datasets to read separately into dfs
# test <- fread("GLB.Ts+dSST.csv", skip = 1, header = TRUE)
# test2 <- fread("GLB.Ts+dSST.csv", skip = 24)
# test3 <- fread("GLB.Ts+dSST.csv", skip = 48)

# Instead, used awk (see parsetemp.sh) to split the files into 3 sub-csv files

temp.files <- list.files(path = ".", pattern = "nasa_gistemp_[123][.]csv")

# Read files into df list - skip first line, which is string description
temp.data <- lapply(temp.files, function(x) read.csv(x, skip = 1, header = TRUE))
names(temp.data) <- c("airsv6", "airsv7", "ghcnv4")

```

```{r, echo = F, message = F, warning=FALSE}
require(tidyverse)
require(data.table)

# Source import file
# NOTE: CHANGE FILE.LOC TO THE LOCATION OF IMPORTDATA.R ON YOUR MACHINE!
file.loc <- "C:/Users/jvons/Documents/NCF/Data_Munging_EDA/Data_Munging/Scripts"
file.name <- "importdata.R"
source(file.path(file.loc, file.name))



# Moving window function, which will subset a df into a list of dfs by desired month cycle
df_window_subset <- function(df, init.year.wind = 2003, wind.size = 2, final.init.year = 2019) {
    moving.dfsub.list <- list()
    while (init.year.wind <= final.init.year) {
        end.year.wind <- init.year.wind + wind.size
        # Filter for only years in the current window
        # Then filter for only December, year X to Jul, year X + 2
        moving.df <- df %>%
                        filter(Year >= init.year.wind & Year <= end.year.wind) %>%
                        filter(!((Year == init.year.wind & Month < 12) | (Year == end.year.wind & Month > 7)))
        moving.dfsub.list[[paste(init.year.wind, end.year.wind, sep = "-")]] <- as.data.frame(moving.df)
        init.year.wind <- init.year.wind + wind.size
    }
    return(moving.dfsub.list)
}

# Adds a column of Date objects to a df from cols named Year and Month. Assumes day is constant (1 by default)
add_date_col <- function(df, day = 1) {
    df <- df %>% mutate(Date = as.Date(paste(Year, Month, day, sep = "-"),
                                       format = "%Y-%m-%d"))
    return(df)
}

wrangle_tempdata <- function() {
    # Need to convert asterisk values to NA in order to convert the data to long format
    # pivot_longer() cannot combine columns that are of diff atomic types
    # For each data frame of temp.data, take each column and replace ***** with NA
    temp.data.na <- lapply(temp.data,
                        function(df) as.data.frame(lapply(df, function(x) gsub(x, pattern = "\\*.*",
                                                                                replacement = NA))))

    # Convert data to long format to allow for date-based time series plot
    temp.data.long <- lapply(temp.data.na, function(df) df %>%
                            pivot_longer(cols = "Jan":"Dec",
                                         names_to = "Month",
                                         values_to = "Temp_diff"))

    # Converting month abbv to numeric
    # Use data.table::set() to modify col j of the df in place for use in lapply - avoids requiring for loop
    # Sets the value of col j to that given by the value argument
    lapply(temp.data.long, function(df) set(df, j = "Month", value = match(df$"Month", month.abb)))

    # Add Date object column for time series analysis
    temp.data.date <- lapply(temp.data.long, add_date_col)

    # For each data frame in temp.data.long, create the windowed subset df
    # This produces for each df, a list of sub-dfs
    # Sub-dfs can be indexed by, e.g., list$airsv6$"2003-2005"
    windowed.df.list <- lapply(temp.data.date, df_window_subset)
    return(windowed.df.list)
}

wrangle_gasdata <- function() {
    # Use replace_with_na() from  packagenaniar to replace values of -9.99 with NA
    # See https://cran.r-project.org/web/packages/naniar/vignettes/replace-with-na.html
    if (!require(naniar)) {
        install.packages("naniar", quietly = TRUE)
    }
    gas.data.na <- lapply(gas.data, function(df) df %>% 
                            replace_with_na(replace = list(Uncertainty_avg = -9.99,
                                                           Uncertainty_trend = -9.99)))
    gas.data.date <- lapply(gas.data.na, add_date_col)
    gas.data.windowed.list <- lapply(gas.data.date, df_window_subset)
    return(gas.data.windowed.list)
}

```

```{r}
# CH4
ch4 <- as.data.frame(gas.data[1])
names(ch4) <- gsub('ch4.', "", names(ch4))

# make ch4 dataframes (18 mos)
ch4 <- df_window_subset(ch4)

ch4_1 <- as.data.frame(ch4[1])
ch4_2 <- as.data.frame(ch4[2])
ch4_3 <- as.data.frame(ch4[3])
ch4_4 <- as.data.frame(ch4[4])
ch4_5 <- as.data.frame(ch4[5])
ch4_6 <- as.data.frame(ch4[6])
ch4_7 <- as.data.frame(ch4[7])
ch4_8 <- as.data.frame(ch4[8])
ch4_9 <- as.data.frame(ch4[9])

# fix col names
names(ch4_1) <- substring(names(ch4_1), 12)
names(ch4_2) <- substring(names(ch4_2), 12)
names(ch4_3) <- substring(names(ch4_3), 12)
names(ch4_4) <- substring(names(ch4_4), 12)
names(ch4_5) <- substring(names(ch4_5), 12)
names(ch4_6) <- substring(names(ch4_6), 12)
names(ch4_7) <- substring(names(ch4_7), 12)
names(ch4_8) <- substring(names(ch4_8), 12)
names(ch4_9) <- substring(names(ch4_9), 12)

# add dates
ch4_1 <- add_date_col(ch4_1)
ch4_2 <- add_date_col(ch4_2)
ch4_3 <- add_date_col(ch4_3)
ch4_4 <- add_date_col(ch4_4)
ch4_5 <- add_date_col(ch4_5)
ch4_6 <- add_date_col(ch4_6)
ch4_7 <- add_date_col(ch4_7)
ch4_8 <- add_date_col(ch4_8)
ch4_9 <- add_date_col(ch4_9)

# make one df
ch4_df <- rbind(ch4_1, ch4_2, ch4_3, ch4_4, ch4_5, ch4_6, ch4_7, ch4_8, ch4_9)
ch4_df$Period <- NA
ch4_df$Period[1:20] <- "Dec '03 - July '05"
ch4_df$Period[21:40] <- "Dec '05 - July '07"
ch4_df$Period[41:60] <- "Dec '07 - July '09"
ch4_df$Period[61:80] <- "Dec '09 - July '11"
ch4_df$Period[81:100] <- "Dec '11 - July '13"
ch4_df$Period[101:120] <- "Dec '13 - July '15"
ch4_df$Period[121:140] <- "Dec '15 - July '17"
ch4_df$Period[141:160] <- "Dec '17 - July '19"
ch4_df$Period[161:180] <- "Dec '19 - July '21"

# calculate mean over 18 mo periods
ch4_periods <- c(1,2,3,4,5,6,7,8,9)
ch4_period_names <- names(ch4)
ch4_period_means <- c(mean(ch4_1$Average_ppb), mean(ch4_2$Average_ppb), mean(ch4_3$Average_ppb),
                  mean(ch4_4$Average_ppb), mean(ch4_5$Average_ppb), mean(ch4_6$Average_ppb),
                  mean(ch4_7$Average_ppb), mean(ch4_8$Average_ppb), mean(ch4_9$Average_ppb))

ch4_period_df <- data.frame(ch4_periods, ch4_period_names, ch4_period_means)




# N2O
n2o <- as.data.frame(gas.data[2])
names(n2o) <- gsub('n2o.', "", names(n2o))

# make n2o dataframes (18 mos)
n2o <- df_window_subset(n2o)

n2o_1 <- as.data.frame(n2o[1])
n2o_2 <- as.data.frame(n2o[2])
n2o_3 <- as.data.frame(n2o[3])
n2o_4 <- as.data.frame(n2o[4])
n2o_5 <- as.data.frame(n2o[5])
n2o_6 <- as.data.frame(n2o[6])
n2o_7 <- as.data.frame(n2o[7])
n2o_8 <- as.data.frame(n2o[8])
n2o_9 <- as.data.frame(n2o[9])

# fix col names
names(n2o_1) <- substring(names(n2o_1), 12)
names(n2o_2) <- substring(names(n2o_2), 12)
names(n2o_3) <- substring(names(n2o_3), 12)
names(n2o_4) <- substring(names(n2o_4), 12)
names(n2o_5) <- substring(names(n2o_5), 12)
names(n2o_6) <- substring(names(n2o_6), 12)
names(n2o_7) <- substring(names(n2o_7), 12)
names(n2o_8) <- substring(names(n2o_8), 12)
names(n2o_9) <- substring(names(n2o_9), 12)

# add dates
n2o_1 <- add_date_col(n2o_1)
n2o_2 <- add_date_col(n2o_2)
n2o_3 <- add_date_col(n2o_3)
n2o_4 <- add_date_col(n2o_4)
n2o_5 <- add_date_col(n2o_5)
n2o_6 <- add_date_col(n2o_6)
n2o_7 <- add_date_col(n2o_7)
n2o_8 <- add_date_col(n2o_8)
n2o_9 <- add_date_col(n2o_9)

# make one df
n2o_df <- rbind(n2o_1, n2o_2, n2o_3, n2o_4, n2o_5, n2o_6, n2o_7, n2o_8, n2o_9)
n2o_df$Period <- NA
n2o_df$Period[1:20] <- "Dec '03 - July '05"
n2o_df$Period[21:40] <- "Dec '05 - July '07"
n2o_df$Period[41:60] <- "Dec '07 - July '09"
n2o_df$Period[61:80] <- "Dec '09 - July '11"
n2o_df$Period[81:100] <- "Dec '11 - July '13"
n2o_df$Period[101:120] <- "Dec '13 - July '15"
n2o_df$Period[121:140] <- "Dec '15 - July '17"
n2o_df$Period[141:160] <- "Dec '17 - July '19"
n2o_df$Period[161:180] <- "Dec '19 - July '21"

# calculate mean over 18 mo periods
n2o_periods <- c(1,2,3,4,5,6,7,8,9)
n2o_period_names <- names(n2o)
n2o_period_means <- c(mean(n2o_1$Average_ppb), mean(n2o_2$Average_ppb), mean(n2o_3$Average_ppb),
                      mean(n2o_4$Average_ppb), mean(n2o_5$Average_ppb), mean(n2o_6$Average_ppb),
                      mean(n2o_7$Average_ppb), mean(n2o_8$Average_ppb), mean(n2o_9$Average_ppb))

n2o_period_df <- data.frame(n2o_periods, n2o_period_names, n2o_period_means)




# SF6
sf6 <- as.data.frame(gas.data[3])
names(sf6) <- gsub('sf6.', "", names(sf6))

# make sf6 dataframes (18 mos)
sf6 <- df_window_subset(sf6)

sf6_1 <- as.data.frame(sf6[1])
sf6_2 <- as.data.frame(sf6[2])
sf6_3 <- as.data.frame(sf6[3])
sf6_4 <- as.data.frame(sf6[4])
sf6_5 <- as.data.frame(sf6[5])
sf6_6 <- as.data.frame(sf6[6])
sf6_7 <- as.data.frame(sf6[7])
sf6_8 <- as.data.frame(sf6[8])
sf6_9 <- as.data.frame(sf6[9])

# fix col names
names(sf6_1) <- substring(names(sf6_1), 12)
names(sf6_2) <- substring(names(sf6_2), 12)
names(sf6_3) <- substring(names(sf6_3), 12)
names(sf6_4) <- substring(names(sf6_4), 12)
names(sf6_5) <- substring(names(sf6_5), 12)
names(sf6_6) <- substring(names(sf6_6), 12)
names(sf6_7) <- substring(names(sf6_7), 12)
names(sf6_8) <- substring(names(sf6_8), 12)
names(sf6_9) <- substring(names(sf6_9), 12)

# add dates
sf6_1 <- add_date_col(sf6_1)
sf6_2 <- add_date_col(sf6_2)
sf6_3 <- add_date_col(sf6_3)
sf6_4 <- add_date_col(sf6_4)
sf6_5 <- add_date_col(sf6_5)
sf6_6 <- add_date_col(sf6_6)
sf6_7 <- add_date_col(sf6_7)
sf6_8 <- add_date_col(sf6_8)
sf6_9 <- add_date_col(sf6_9)

# make one df
sf6_df <- rbind(sf6_1, sf6_2, sf6_3, sf6_4, sf6_5, sf6_6, sf6_7, sf6_8, sf6_9)
sf6_df$Period <- NA
sf6_df$Period[1:20] <- "Dec '03 - July '05"
sf6_df$Period[21:40] <- "Dec '05 - July '07"
sf6_df$Period[41:60] <- "Dec '07 - July '09"
sf6_df$Period[61:80] <- "Dec '09 - July '11"
sf6_df$Period[81:100] <- "Dec '11 - July '13"
sf6_df$Period[101:120] <- "Dec '13 - July '15"
sf6_df$Period[121:140] <- "Dec '15 - July '17"
sf6_df$Period[141:160] <- "Dec '17 - July '19"
sf6_df$Period[161:180] <- "Dec '19 - July '21"

# caculate mean over 18 mo periods
sf6_periods <- c(1,2,3,4,5,6,7,8,9)
sf6_period_names <- names(sf6)
sf6_period_means <- c(mean(sf6_1$Average_ppb), mean(sf6_2$Average_ppb), mean(sf6_3$Average_ppb),
                      mean(sf6_4$Average_ppb), mean(sf6_5$Average_ppb), mean(sf6_6$Average_ppb),
                      mean(sf6_7$Average_ppb), mean(sf6_8$Average_ppb), mean(sf6_9$Average_ppb))

sf6_period_df <- data.frame(sf6_periods, sf6_period_names, sf6_period_means)


############################################################################

# make data frames with every month 12/03-07/22

ch4_nonperiod <- as.data.frame(gas.data[1])

names(ch4_nonperiod) <- gsub('ch4.', "", names(ch4_nonperiod))

n2o_nonperiod <- as.data.frame(gas.data[2])

names(n2o_nonperiod) <- gsub('n2o.', "", names(n2o_nonperiod))

sf6_nonperiod <- as.data.frame(gas.data[3])

names(sf6_nonperiod) <- gsub('sf6.', "", names(sf6_nonperiod))

```

### EDA Plots

The first 3 boxplots show the variation of the gas data for each of the 20 month periods. The Covid period we defined is Decemeber 2019 to July 2021. 

The next plots are a linear model that makes a prediction for the year 2050 with and without our Covid period. 

```{r}

theme_bluewhite <- function(base_size = 11, base_family = "") {
  theme_bw() %+replace% 
    theme(
      panel.grid.major  = element_line(color = "white"),
      panel.background = element_rect(fill = "lightblue"),
      panel.border = element_rect(color = "lightblue", fill = NA),
      axis.line = element_line(color = "lightblue"),
      axis.ticks = element_line(color = "lightblue"),
      axis.text = element_text(color = "steelblue")
    )
}

a <- ggplot(ch4_df) + 
  geom_boxplot(aes(x = as.factor(Period), y = Average_ppb)) + 
  labs(title = "CH4") + xlab("20 Month Period") + ylab("PPB") + 
  theme_bluewhite() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.5,
      vjust = .5
    ))

b <- ggplot(n2o_df) + 
  geom_boxplot(aes(x = as.factor(Period), y = Average_ppb)) + 
  labs(title = "N2O") + xlab("20 Month Period") + ylab("PPB") + 
  theme_bluewhite() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.5,
      vjust = .5
    ))

c <- ggplot(sf6_df) + 
  geom_boxplot(aes(x = as.factor(Period), y = Average_ppb)) + 
  labs(title = "SF6") + xlab("20 Month Period") + ylab("PPB") + 
  theme_bluewhite() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.5,
      vjust = .5
    ))

plot_grid(a, b, c)

```
```{r message = F}
x <- ggplot() +
  geom_point(data = ch4_nonperiod[12:218,], aes(x = Year_Day_decimal, y = Average_ppb))+
  geom_smooth(data = ch4_df, aes(x = Year_Day_decimal, y = Average_ppb, col = "With Covid Period"), method = "lm", 
              fullrange = TRUE) +
  geom_smooth(data = ch4_df[1:160, ], aes(x = Year_Day_decimal, y = Average_ppb, col = "Without Covid Period"),
              method = "lm", fullrange=TRUE) + xlim(c(2003,2050)) + 
  xlab("Year") + ylab("PPB") + ggtitle("CH4") +
  scale_color_manual(name='Linear Trend', breaks=c('With Covid Period', 'Without Covid Period'),
                     values=c('With Covid Period'='blue', 'Without Covid Period'='red'))


y <- ggplot() +
  geom_point(data = n2o_nonperiod[12:218,], aes(x = Year_Day_decimal, y = Average_ppb))+
  geom_smooth(data = n2o_df, aes(x = Year_Day_decimal, y = Average_ppb, col = "With Covid Period"), method = "lm", 
              fullrange = TRUE) +
  geom_smooth(data = n2o_df[1:160, ], aes(x = Year_Day_decimal, y = Average_ppb, col = "Without Covid Period"),
              method = "lm", fullrange=TRUE) + xlim(c(2003,2050)) + 
  xlab("Year") + ylab("PPB") + ggtitle("N2O") +
  scale_color_manual(name='Linear Trend', breaks=c('With Covid Period', 'Without Covid Period'),
                     values=c('With Covid Period'='blue', 'Without Covid Period'='red'))


z <- ggplot() +
  geom_point(data = sf6_nonperiod[12:218,], aes(x = Year_Day_decimal, y = Average_ppb))+
  geom_smooth(data = sf6_df, aes(x = Year_Day_decimal, y = Average_ppb, col = "With Covid Period"), method = "lm", 
              fullrange = TRUE) +
  geom_smooth(data = sf6_df[1:160, ], aes(x = Year_Day_decimal, y = Average_ppb, col = "Without Covid Period"),
              method = "lm", fullrange=TRUE) + xlim(c(2003,2050)) + 
  xlab("Year") + ylab("PPB") + ggtitle("SF6") +
  scale_color_manual(name='Linear Trend', breaks=c('With Covid Period', 'Without Covid Period'),
                     values=c('With Covid Period'='blue', 'Without Covid Period'='red'))

plot_grid(x,y,z)

```

### Interpretations

Below are the regression line formulas used to calculate the 2050 PPB prediction with and without the Covid period. The results of the linear model were opposite to what we expected. Removing the Covid period increased the predicted PPB across the board for our three greenhouse gasses of interest. 

```{r, message=FALSE}
# 2050 predictions
options(scipen=999)

#ch4 with covid
lm <- lm(formula = ch4_df$Average_ppb ~ ch4_df$Year_Day_decimal)

#ch4 without covid
lm_wo <- lm(formula = ch4_df[1:160, ]$Average_ppb ~ ch4_df[1:160, ]$Year_Day_decimal)

#n2o with covid
lm1 <- lm(formula = n2o_df$Average_ppb ~ n2o_df$Year_Day_decimal)

# n2o without covid
lm1_wo <- lm(formula = n2o_df[1:160, ]$Average_ppb ~ n2o_df[1:160, ]$Year_Day_decimal)

# sf6 with covid
lm2 <- lm(formula = sf6_df$Average_ppb ~ sf6_df$Year_Day_decimal)

# sf6 without covid
lm2_wo <- lm(formula = sf6_df[1:160, ]$Average_ppb ~ sf6_df[1:160, ]$Year_Day_decimal)

```

#### 2050 Predictions

CH4 prediction with covid period: `r lm$coefficients[1] + (lm$coefficients[2] * 2050.5)` ppb.

CH4 prediction without covid period: `r lm_wo$coefficients[1] + (lm_wo$coefficients[2] * 2050.5)` ppb.

N2O prediction with covid period: `r lm1$coefficients[1] + (lm1$coefficients[2] * 2050.5)` ppb

N2O prediction without covid period: `r lm1_wo$coefficients[1] + (lm1_wo$coefficients[2] * 2050.5)` ppb.

SF6 prediction with covid period: `r lm2$coefficients[1] + (lm2$coefficients[2] * 2050.5)` ppb

SF6 prediction without covid period: `r lm2_wo$coefficients[1] + (lm2_wo$coefficients[2] * 2050.5)` ppb.
